\chapter{Введение}
В настоящее время развитие встраиваемых систем приобретает массовый характер. Новые решения встраиваемых систем становятся все более и более производительны, и способны брать на себя решения задач, которые до недавнего времени были доступны лишь компьютерам. Круг задач, которые решают встраиваемые системы очень широк, начиная от блока управления подсветкой и заканчивая высокопроизводительными маршрутизаторами и мобильными устройствами. 

Сердцем всех встраиваемых систем является микроконтроллер --- микросхема, предназначенная для управления электронными устройствами.

Благодаря использованию широко известных высокоуровневых языков, таких как С и С++, микроконтроллеры обеспечивают достаточно низкий порог вхождения в разработку, в отличии от ПЛИС, где разработку приходится вести на языках VeryLog и VHDL. Наличие средств разработки и их кроссплатформенность позволяют вести разработку в любом удобном пользовательском окружении, будь то Windows или MacOS и Linux. 

Одним из преимуществ микроконтроллеров является универсальность средств разработки, позволяющие вести разработку под микроконтроллеры с разной архитектурой, будь то ARM, AVR, PIC, MSP430 и др. Примером таких средств разработки являются IAR Embedded Workbench, Keil, Eclipse.

Быстрые темпы развития цифровой техники и применение микроконтроллеров обуславливают необходимость подготовки специалистов соответствующего уровня. Одним из направлений курса ЯОАО кафедры 403 МАИ является изучение разработки устройств на программируемой элементной базе. В связи с этим разработка цикла лабораторных работ должна стать связующим звеном между теоретическим материалом, даваемым на лекциях и практическими навыками. Предлагаемый цикл работ должен познакомить студента с разработкой выстаиваемых систем на микроконтроллерах, с современной элементной базой и периферией.









\section{Обзор современный микроконтроллерных ядер}
В настоящее время существуют 2-е архитектуры микроконтроллеров -- гарвардская архитектура и фон-неймановская архитектура. Ниже рассмотрены основные семестра микроконтроллеров: PIC, AVR, MSP430, ARM.

\textit{PIC} --- микроконтроллеры Гарвардской архитектуры, производимые американской компанией Microchip Technology Inc. Название PIC является сокращением от Peripheral Interface Controller, что означает <<периферийный интерфейсный контроллер>>. Первые микроконтроллеры компании MICROCHIP PIC16C5x появились в конце 80-х годов и благодаря своей высокой производительности и низкой стоимости составили серьёзную конкуренцию производимым в то время 8-разрядным МК с CISC-архитектурой.
В основу концепции PIC, единую для всех выпускаемых семейств, была положена RISC-архитектура с системой простых однословных команд, применение встроенной памяти программ и данных и малое энергопотребление.

8-битные микроконтроллеры делятся на 2 больших семейства: PIC10/12/16 и PIC18. Микроконтроллеры PIC10/12/16 представлены двумя базовыми архитектурами ядра: BASELINE и MID-RANGE.

Система команд архитектуры Baseline имеет 33 команды. Все команды (кроме команд перехода) выполняются за один машинный цикл (или четыре машинных такта) с перекрытием по времени выборок команд и их исполнения, что позволяет достичь производительности до 5 MIPS при тактовой частоте 20 МГц. 

Mid-range PIC16x/7x/8x/9x с 14-разрядными командами. Наиболее многочисленное семейство, объединяющее микроконтроллеры с разнообразными периферийными устройствами, в число которых входят аналоговые компараторы, аналогово-цифровые преобразователи, контроллеры последовательных интерфейсов SPI, USART и I2C, таймеры-счётчики, модули захвата/сравнения, широтно-импульсные модуляторы, сторожевые таймеры, супервизорные схемы и тд.

Благодаря своей простоте и наличию большого количества документации PIC микроконтроллеры часто используются для изучения embedded программирования.


\textit{AVR} --- семейство 8-битных микроконтроллеров фирмы Atmel. Микроконтроллеры AVR, также, как и PIC, имеют гарвардскую архитектуру (программа и данные находятся в разных адресных пространствах) и систему команд, близкую к идеологии RISC. Процессор AVR имеет 32 8-битных регистра общего назначения, объединённых в регистровый файл.

Система команд микроконтроллеров AVR весьма развита и насчитывает в различных моделях от 90 до 133 различных инструкций. Всё множество команд микроконтроллеров AVR можно разбить на несколько групп:
\begin{itemize}
\item команды логических операций;


\itemкоманды логических операций;
\itemкоманды арифметических операций и команды сдвига;
\itemкоманды операции с битами;
\item    команды пересылки данных;
\item    команды передачи управления;
\item    команды управления системой.
\end{itemize}
\\
Существуют стандартные семейства микроконтроллеров AVR:
\begin{itemize}
\item tinyAVR (ATtinyxxx);
\item megaAVR (ATmegaxxx);
\item XMEGA AVR (ATxmegaxxx);
\end{itemize}

Семейства отличаются  разным объемом флеш памяти, SRAM, EEPROM, разным количеством GPIO и разным набором системы команд и периферийных устройств.
Кроме указанных выше семейств, ATMEL выпускает 32-разрядные микроконтроллеры семейства AVR32.
На базе микроконтроллеров ATmega разрабатывают популярную платформу Arduino.


\textit{MSP430} --- семейство 16-разрядных микроконтроллеров фирмы <<Texas Instruments>>.
MSP430 имеет фон-неймановскую архитектуру, с единым адресным пространством для команд и данных. Память может адресоваться как побайтово, так и пословно. Порядок хранения 16-разрядных слов -- от младшего к старшему (little-endian).
Процессор содержит 16 16 -- разрядных ортогональных регистров. Регистр R0 используется как программный указатель (Program Counter -- PC), регистр R1 как указатель стека (Stack Pointer -- SP), регистр R2 как регистр статуса (Status Register -- SR), а R3 как специальный регистр именуемый генератор констант (Constant Generator -- CG), R2 также может использоваться в качестве генератора констант. Генератор констант используется для сокращения общей длины команды вследствие неявного представления константы в коде операции. Регистры с R4 по R15 используются как регистры общего назначения.

Набор инструкций представлен 27 инструкциями, 24 эмулированными инструкциями. Инструкции имеют как 8-битную (байт), так и 16 -- битную (слово) форму обработки операндов.

Ключевым отличием семейства MSP430 является возможность тактировать любой модуль периферии асинхронно от ядра. В подавляющем большинстве однокристальных микроконтроллеров периферия синхронна с ядром (за исключением таймера часов реального времени). Такая особенность позволяет гибко управлять скоростью и потреблением каждого модуля.

\textit{ARM} (Advanced RISC Machine) --- семейство лицензируемых 32-битных и 64-битных микропроцессорных ядер разработки компании ARM Limited.
ARM широко используются в потребительской электронике -- в том числе КПК, мобильных телефонах, цифровых носителях и плеерах, портативных игровых консолях, калькуляторах и компьютерных периферийных устройствах, таких как жесткие диски или маршрутизаторы.

Эти процессоры имеют низкое энергопотребление, поэтому находят широкое применение во встраиваемых системах и преобладают на рынке мобильных устройств.
В настоящее время значимы несколько семейств процессоров ARM:
\begin{itemize}

\item ARM7 (с тактовой частотой до 60-72 МГц), предназначенные для недорогих мобильных телефонов и встраиваемых решений средней производительности. В настоящее время активно вытесняется новым семейством Cortex.
\item ARM9, ARM11 (с частотами до 1 ГГц) для продвинутых телефонов, карманных компьютеров и встраиваемых решений высокой производительности.
\item Cortex A --- новое семейство процессоров на смену ARM9 и ARM11.
\item Cortex M --- новое семейство процессоров на смену ARM7, также призванное занять новую для ARM нишу встраиваемых решений низкой производительности. В семействе присутствуют три значимых ядра: Cortex M0, Cortex M3 и Cortex M4.

\end{itemize}
\\
Начиная с ARMv7 были определены 3 профиля:
\begin{itemize}
\item A (application) --- для устройств, требующих высокой производительности (смартфоны, планшеты);
\item R (real time) --- для приложений, работающих в реальном времени;
\item M (microcontroller) --- для микроконтроллеров и недорогих встраиваемых устройств;
\end{itemize}
\\Архитектура ARM обладает следующими особенностями RISC:
\begin{itemize}
\item Архитектура загрузки/хранения
\item Нет поддержки нелинейного (не выровненного по словам) доступа к памяти (теперь поддерживается в процессорах ARMv6 за некоторыми исключениями и полностью в ARMv7)
\item Равномерный 16х32-битный регистровый файл
\item Фиксированная длина команд (32 бита) для упрощения декодирования за счет снижения плотности кода. Позднее режим Thumb повысил плотность кода.
\item Одноцикловое исполнение
\end{itemize}





\section{Анализ существующих отладочных плат}
Одним из основных производителей микроконтроллеров семейства Cortex-M3/M4 является фирма STMicroelectronics --- европейская микроэлектронная компания, занимающихся разработкой, изготовлением и продажей различных полупроводниковых электронных и микроэлектронных компонентов. STMicroelectronics занимается разработкой собственных отладочных плат для своих микроконтроллеров. Для семейства Cortex-M3/M4 разработаны отладочные платы STM32L-DISCOVERY, STM32F3DISCOVERY, STM32F4DISCOVERY и др. Также отладочные платы для семейства Cortex-M3/M4 выпускают многочисленные китайские производители, но характеристики данных плат сильно отличаются друг от друга.
\subsection{STM32L - DISCOVERY}
STM32L - Discovery --- отладочный набор для разработки на микроконтроллерах STM32L, построенными на базе ядра Cortex-M3, отличающиеся ультра низким энергопотреблением (порядка 270нА в спящем режиме).

В основе STM32L - Discovery заложен 32МГц микроконтроллер STM32L152RBT6 с 128 KБ Flash, 16 KБ RAM и 4 KБ EEPROM. Наличие встроенного программатора-отладчика ST-LINK. Сигналы встроенного ST-Link выведены на внешний разъем, что позволяет в дальнейшем использовать STM32L-Discovery в качестве программатора-отладчика других разработок.
\begin{figure}[h!]
\begin{center}
\includegraphics[scale=1]{Image/1.jpg}
\end{center}
\caption{Отладочная плата STM32L - Discovery}
\end{figure}

\\Отличительные особенности:
\begin{itemize}
\item Микроконтроллер STM32L152RBT6
\item Ядро Cortex-M3, 128 KB Flash, 16 KB RAM, 4 KB EEPROM
\item Интерфейсы USB 2.0 FS, 3xUSART, 2xSPI, 2xI2C, 8 таймеров
\item  24-канальный 12-бит АЦП 1мкс, компараторы, 2х12-бит ЦАП
\item Полноценные часы реального времени
\item Встроенный контроллер LCD 8х40
\item Встроенный программатор ST-Link с возможностью программировать другие микроконтроллеры STM32.
\item LCD дисплей 24х8 в форм-факторе DIP28
\item Возможность измерения потребляемого тока
\item Четыре светодиода:
\item LD1 (красный/зеленый) для сигнализации обмена данных по USB
\item LD2 (красный) для питания 3.3В
\item Два пользовательских диода LD3 (зеленый) и LD4 (синий)
\item Две кнопки (user и reset)
\item Сенсорная клавиатура (четыре сенсорных кнопки или один слайдер)
\item Все свободные выводы STM32L152RBT6 выведены на контактные площадки
\end{itemize}

\subsection{STM32F3DISCOVERY}

STM32F3DISCOVERY --- отладочный набор для разработки и отладки приложений на микроконтроллерах семейства STM32F3. В состав набора входит высоко интегрированная отладочная плата с богатой периферией, включая МЕМС датчики: гироскоп (L3GD20) и совмещенное решение акселерометр с компасом (LSM303DLHC). Такое решение позволит пользователям оценить возможности встроенного ядра цифрового сигнального процессора и блока арифметики с плавающей точкой, а также продемонстрирует одновременную работу с несколькими МЕМС устройствами. 


\begin{figure}[h!]
\begin{center}
\includegraphics[scale=1]{Image/2.jpg}
\end{center}
\caption{Отладочная плата STM32F3DISCOVERY}
\end{figure}

Набор имеет все необходимое программное и аппаратное обеспечение. Помимо МЕМС датчиков на плате расположены порт USB, пользовательские светодиоды, кнопки и что самое важное -- встроенный отладчик-программатор ST-LINK/V2.

Отличительные особенности:
\begin{itemize}
\item Установлен микроконтроллер STM32F303VCT6:
\begin{itemize}
\item Ядро ARM Cortex-M4, рабочая частота до 72 МГц;
\item Поддержка DSP инструкций с плавающей точкой;
\item Модуль защиты памяти;
\item 256 КБайт Flash-память, 48 КБайт ОЗУ;
\item 12-канальный DMA контроллер;
\item До 13 таймеров с расширенным функционалом;
\item Часы реального времени с календарем и будильником;
\item Четыре АЦП с конфигурируемым разрешением 12/10/8/6 бит;
\item Два 12-битных ЦАП;
\item 7 аналоговых компараторов;
\item 4 программируемых операционных усилителя;
\item Поддержка сенсорного интерфейса;
\item Коммуникационные интерфейсы: CAN, I2C, USART/UART, I2S, USB 2.0;
\item До 87 линий ввода/вывода общего назначения;
\end{itemize}
\item Питание от интерфейса USB или от внешнего источника 3 В или 5 В;
\item Установлен 3-осевой цифровой МЕМС гироскоп;
\item Установлена МЕМС система-в-корпусе, содержащая 3-осевой цифровой линейный акселерометр и 3-осевой цифровой геомагнитный сенсор;
\item 10 светодиодов, две пользовательские кнопки;
\item Пользовательский порт USB;
\end{itemize}
\subsection{STM32F4DISCOVERY}
STM32F4DISCOVERY --- высокопроизводительная исследовательская плата для микроконтроллера STM32F4 позволяет изучать возможности микроконтроллера STM32F4 и легко разрабатывать собственные приложения. Основанная на STM32F407VGT6, плата имеет интегрированный отладчик ST-LINK/V2, два ST MEMS, цифровой измеритель ускорения (акселерометр) и цифровой микрофон, один аудио ЦАП с интегрированным драйвером громкоговорителя, работающим в классе D, светодиоды и кнопки, а также разъем USB OTG micro-AB.

\begin{figure}[h!]
\begin{center}

\includegraphics[scale=1]{Image/3.jpg}

\end{center}
\caption{Отладочная плата STM32F4DISCOVERY}
\end{figure}
\\Отличительные особенности:
\begin{itemize}
\item Микроконтроллер STM32F407VGT6, основанный на 32-разрядном ядре ARM Cortex-M4F, с 1 МБайт Flash памяти, 192 кБайт ОЗУ в корпусе LQFP100;
\itemВстроенный отладчик ST-LINK/V2 с выбором режима работы, позволяющим использовать набор как автономный STLINK/ V2 (с разъемом SWD для программирования и отладки);
\itemПодача напряжения питания на плату: через шину USB или от внешнего источника питания 5 В;
\itemИсточник питания внешних приложений с выходным напряжением 3 В и 5 В;
\itemLIS302DL, ST MEMS датчик движения, 3-осевой акселерометр с цифровым выходом;
\itemMP45DT02, ST MEMS аудио датчик, всенаправленный цифровой микрофон;
\itemCS43L22, аудио ЦАП с интегрированным усилителем класса D для громкоговорителя;
\itemВосемь светодиодов:
\begin{itemize}
\item LD1 (красный/зеленый) для USB коммуникаций,
\item LD2 (красный) для индикации наличия напряжения 3,3 В,
\item Четыре пользовательских светодиода, LD3 (оранжевый), LD4 (зеленый), LD5 (красный) и LD6 (синий),
\item 2 USB OTG светодиода LD7 (зеленый) VBus и LD8 (красный) перегрузка по току;
\end{itemize}
\item Две кнопки: пользовательская и сброс (reset);
\item USB OTG FS с разъемом micro-AB;
\item Внешний разъем с выходом всех линий I/O корпуса LQFP100 для быстрого подключения к макетной плате и простого исследования сигналов.
\end{itemize}


\section{Выбор языка описания аппаратного обеспечения}
Для разработки программ под микроконтроллеры, в основном, используют языки Assembler, C, C++. Существуют разработки по программированию под микроконтроллеры на языках высокого уровня, таких как, C\# (проект .NET Micro Framework), Java (различные реализации виртуальных машин Java, такие как NanoVM, HaikuVM, leJOS, TakaTuka, Bajos и др.), а также интерпретаторы для программирования на JavaScript (javascript-интерпретатор для микроконтроллеров Espruino и проект Tessel). Для некоторых проектов разрабатываются собственные языки программирования. Популярная сегодня отладочная платы Arduino использует язык Wiring --- язык основанный на C/C++ с большим количеством стандартных функций.  Проект Enegria позволяет использовать язык Wiring для разработки под платформу MSP430 Launchpad от Texas Instruments.

Микроконтроллеры сегодня проходят путь, который до этого проходили процессоры для персональных компьютеров. Разработчики стараются использовать решения, повышающие уровень абстракции программных продуктов, при разработке под микроконтроллеры. При разработке больших проектов используются операционных системы реального времени (ОСРВ), позволяющие управлять задачами, динамически распределять память, управлять таймерами, контролировать устройства ввода-вывода, выполнять взаимодействие между задачами. Примерами таких ОСРВ являются FreeRTOS, uOS, ChibiOS/RT, XOberon (ОСРВ для БПЛА, написана на Обероне SA) и другие.

При выборе языка для подготовки студентов в рамках лабораторных работ важно учитывать знание студентами языка и его простоту. Наиболее простым для изучения языком является Wiring, он имеет очень низкий порог вхождения и позволяют разрабатывать программы для микроконтроллера в короткий срок, однако язык не позволяет в полной мере изучить принципы работы с периферией микроконтроллера. Более сложным в изучении является язык C, однако, он позволяет, в полной мере, работать с регистрами микроконтроллера и управлять памятью. Кроме того, студенты изучают язык С на других дисциплинах. Все эти факторы показывают, что наиболее оптимальным языком для изучения в рамках дисциплины будет язык С.

\section{Обоснование выбора микроконтроллера и отладочной платы}
Наиболее функциональной и производительной из приведенных выше отладочных плат является STM32F4DISCOVERY в силу используемого микроконтроллера STM32F407VGT6 семейства ARM Cortex M4 и двух MEMS датчиков (гироскоп и акселерометр). Однако, в силу особенностей разрабатываемых лабораторных работ, доступный функционал не будет полностью задействован. В силу этого, наиболее предпочтительным вариантом является отладочная плата STM32L-DISCOVERY, благодаря наличию ЖК-индикатора и сенсорной панели, которые являясь простыми в настройке будут идеальными средствами для обучения студентов.